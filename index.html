<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <script src="https://cdn.jsdelivr.net/npm/brython@3.8.10/brython.min.js">
    </script>
    <script src="https://cdn.jsdelivr.net/npm/brython@3.8.10/brython_stdlib.js">
    </script>
</head>

<body onload="brython()">

<textarea id="zone" rows=10>def fn():
    t.x = 7
    t.sleep()</textarea>
<button type="button" id="mybutton">Test exec()</button>

<script type="text/python">
    from browser import bind, document, alert, worker

    w = worker.Worker("simulator")
    def test(ev):
        w.send({"code": document['zone'].value})
        print("Should print first or second")

    @bind(w, "message")
    def onmessage(obj):
        print(obj.data)

    document["mybutton"].bind("click", test)

    document <= "Hello !"
</script>
<script type="text/python" class="webworker" id="simulator">
    from browser import bind, self

    import time

    class Test():
        def __init__(self):
            self.x = 11
        
        def sleep(self):
            end_time = time.time() + 5
            while time.time() < end_time:
                pass

    @bind(self, "message")
    def thread_fn(obj):
        t = Test()
        env = {"t": t}
        exec(obj.data["code"], env)
        fn = env["fn"]
        fn()
        self.send("hi")

</script>
</body>

</html>
